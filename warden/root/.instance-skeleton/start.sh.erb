#!/bin/bash

# Change to directory that holds this script
cd $(dirname $(readlink -f ${0}))

if [ -f started ]; then
  echo "Container is already running..."
  exit 1
fi

<%= union_mount_command %>
lxc-create -n instance-<%= config["id"] %> -f config
lxc-start -n instance-<%= config["id"] %> -d -o lxc.log
ifconfig veth-<%= config["id"] %> <%= config["network_gateway_ip"] %> netmask <%= config["network_netmask"] %>
touch started

# Wait for the runner socket to come up
start=$(date +%s)
while [ ! -S union/tmp/runner.sock ]; do
  if [ $(($(date +%s) - ${start})) -gt 5 ]; then
    echo "Timeout waiting for runner socket to come up..."
    exit 1
  fi

  sleep 0.1
done
