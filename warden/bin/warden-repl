#!/usr/bin/env ruby
ENV['BUNDLE_GEMFILE'] ||= File.expand_path("../../Gemfile", __FILE__)
$LOAD_PATH.unshift(File.expand_path("../../lib", __FILE__))

require "bundler"
Bundler.setup

require "optparse"

require "warden/repl"

options = {}
OptionParser.new do |op|
  op.banner = <<-EOT
Usage: warden-repl [options]
Runs an interactive REPL by default.

EOT
  op.on("-c COMMAND", "Run COMMAND non-interactively") do |command|
    options[:command] = command
  end

  op.on("-x", "Writes each command preceded by a '+' to stdout before executing") do
    options[:trace] = true
  end
end.parse!

repl = Warden::Repl.new(options)

if options[:command]
  command_info = repl.process_line(options[:command])
  status =
    if command_info[:error]
      1
    elsif command_info[:name] == "run"
      Integer(command_info[:result][0])
    else
      0
    end
  exit status
else
  trap('INT') { exit }
  repl.run
end
