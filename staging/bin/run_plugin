#!/usr/bin/env ruby
#
# This script is responsible for executing a single staging plugin inside of
# a container
#
ENV['BUNDLE_GEMFILE'] ||= File.expand_path('../../Gemfile', __FILE__)

require "rubygems"
require "bundler"

Bundler.setup

require "yajl"

require "vcap/staging/plugin/common"

unless ARGV.length > 2
  $stderr.puts "Usage: run_plugin <src_path> <dst_path> <properties_path>" \
               + " [<manifests_path>]"
  exit 1
end

args = ARGV.dup

begin
  app_properties_json = File.read(args[2])
  args[2] = Yajl::Parser.parse(app_properties_json, :symbolize_keys => true)
rescue => e
  $stderr.puts "Failed parsing app properties file: #{e}"
  exit 1
end

begin
  klass = StagingPlugin.load_plugin_for(args[2][:framework])
  klass.validate_arguments!(*args)
  klass.new(*args).stage_application
rescue => e
  $stderr.puts "Failed staging application: #{e}"
  exit 1
end
