#!/usr/bin/env ruby
ENV['BUNDLE_GEMFILE'] ||= File.expand_path('../../Gemfile', __FILE__)

require 'rubygems'
require 'bundler/setup'

$LOAD_PATH.unshift(File.expand_path('../../lib', __FILE__))

require 'resque'
require 'resque/server'
require 'vegas'

require 'vcap/stager'

config_file = VCAP::Stager::Config::DEFAULT_CONFIG_PATH
OptionParser.new do |op|
  op.on('-c', '--config [FILENAME]', 'Config filename') do |val|
    config_file = val
  end
end.parse!

begin
  config = VCAP::Stager::Config.from_file(config_file)
rescue VCAP::JsonSchema::ValidationError => ve
  puts "ERROR: There was a problem validating the supplied config: #{ve}"
  exit 1
rescue => e
  puts "ERROR: Failed loading config from file '#{config_file}': #{e}"
  exit 1
end

puts config

Resque.redis = Redis.new(config[:redis])
Resque.redis.namespace = config[:redis][:namespace] if config[:redis][:namespace]

Vegas::Runner.new(Resque::Server, 'resque-web')
